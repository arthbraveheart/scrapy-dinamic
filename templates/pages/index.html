{% extends "layouts/base.html" %}
{% load static %}

{% block extrastyle %}
<style>
    .btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .indeterminate {
        animation: progress 2s linear infinite;
    }

    @keyframes progress {
        0% {
            background-position: 0% 50%;
        }
        50% {
            background-position: 100% 50%;
        }
        100% {
            background-position: 0% 50%;
        }
    }
</style>
{% endblock extrastyle %}

{% block extrahead %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock extrahead %}

{% block content %}

<!-- Button trigger modal -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#statusModal">
    Spider Status
</button>

<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusTitle">Processing...</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="progress">
                    <div id="progressBar" class="progress-bar progress-bar-striped indeterminate" role="progressbar"
                         style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <p id="progressStats" class="mt-2 text-center small">0 / 0 EANs processed</p>
                <p id="statusMessage" class="mt-2"></p>
            </div>
        </div>
    </div>
</div>

<form id="spiderForm" method="post" action="{% url 'run-spider' %}">
    {% csrf_token %}
    <button type="submit" class="btn btn-primary" id="submitButton">Run Spider</button>
</form>
{% endblock %}

{% block extra_js %}
<script>
    const submitButton = document.getElementById ('submitButton');
    const statusModal = document.getElementById ('statusModal');
    let checkInterval = null;

    document.addEventListener ('DOMContentLoaded', function () {
        checkSpiderStatus ();
    });

    document.getElementById ('spiderForm').addEventListener ('submit', function (e) {
        e.preventDefault ();
        const modal = new bootstrap.Modal (document.getElementById ('statusModal'));
        modal.show (); // Show modal on form submission

        fetch ("{% url 'run-spider' %}", {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            body: new FormData (this)
        }).then (() => {
            checkSpiderStatus ();
        }).catch (error => {
            const statusTitle = document.getElementById ('statusTitle');
            const statusMessage = document.getElementById ('statusMessage');
            statusTitle.textContent = 'Error!';
            statusMessage.textContent = 'Failed to start spider: ' + error;
        });
    });

    function checkSpiderStatus () {
        fetch (`{% url 'spider-status' %}?t=${Date.now ()}`)
            .then (response => {
                if (!response.ok) throw Error ('Network error');
                return response.json ();
            })
            .then (data => {
                submitButton.disabled = data.status === 'running';
                // Add visual feedback
                submitButton.innerHTML = data.status === 'running'
                    ? '<span class="spinner-border spinner-border-sm" role="status"></span> Running...'
                    : 'Run Spider';
            })
            .catch (console.error);
    }

    // Handle modal show/hide events for polling
    statusModal.addEventListener ('show.bs.modal', function () {
        const statusTitle = document.getElementById ('statusTitle');
        const statusMessage = document.getElementById ('statusMessage');
        const progressBar = document.getElementById ('progressBar');
        const progressStats = document.getElementById ('progressStats');

        // Initialize UI
        statusTitle.textContent = 'Processing...';
        statusMessage.textContent = 'Checking spider status...';
        progressBar.style.width = '0%';
        progressBar.setAttribute ('aria-valuenow', 0);
        progressBar.classList.add ('indeterminate');

        let attempts = 0;
        const MAX_ATTEMPTS = 2000;

        function checkStatus () {
            attempts++;
            if (attempts > MAX_ATTEMPTS) {
                clearInterval (checkInterval);
                statusTitle.textContent = 'Timeout';
                statusMessage.textContent = 'Spider is taking too long. Check status later.';
                return;
            }

            fetch (`{% url 'spider-status' %}?t=${Date.now ()}`)
                .then (response => {
                    if (!response.ok) throw Error ('Network error');
                    return response.json ();
                })
                .then (data => {
                    statusMessage.textContent = data.message || data.status;

                    if (data.progress) {
                        const {percentage, completed, total} = data.progress;
                        progressStats.textContent = `${completed} / ${total} EANs processed`;

                        if (data.status === 'running' && total > 0) {
                            progressBar.style.width = `${percentage}%`;
                            progressBar.setAttribute ('aria-valuenow', percentage);
                            if (percentage > 0) progressBar.classList.remove ('indeterminate');
                        }
                    }

                    if (data.status === 'completed') {
                        statusTitle.textContent = 'Completed!';
                        progressBar.style.width = '100%';
                        progressBar.setAttribute ('aria-valuenow', 100);
                        clearInterval (checkInterval);
                    } else if (data.status.startsWith ('failed') || data.status.startsWith ('error')) {
                        statusTitle.textContent = 'Failed!';
                        clearInterval (checkInterval);
                    }
                })
                .catch (error => {
                    console.error ('Polling error:', error);
                    statusMessage.textContent = 'Connection error - retrying...';
                });
        }

        // Immediate check and then every 2 seconds
        checkStatus ();
        checkInterval = setInterval (checkStatus, 2000);
    });

    statusModal.addEventListener ('hidden.bs.modal', function () {
        if (checkInterval) {
            clearInterval (checkInterval);
            checkInterval = null;
        }
    });
</script>
{% endblock extra_js %}